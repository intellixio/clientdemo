<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intellixio Client Chat</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’¬</text></svg>">
    
    <style>
        :root {
            --bg-color: #f0f4f8; --page-header-bg: #ffffff;
            --chat-bubble-user-bg: #007bff; --chat-bubble-user-text: #ffffff;
            --chat-bubble-ai-bg: #e9ecef; --chat-bubble-ai-text: #212529;
            --text-color: #333; --border-color: #d1d9e6; --input-bg: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1); --bubble-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        }
        [data-theme="dark"] {
            --bg-color: #121212; --page-header-bg: #1e1e1e;
            --chat-bubble-user-bg: #3730a3; --chat-bubble-user-text: #e0e0e0;
            --chat-bubble-ai-bg: #333333; --chat-bubble-ai-text: #e0e0e0;
            --text-color: #e0e0e0; --border-color: #2c2c2c; --input-bg: #2c2c2c;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.4); --bubble-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { height: 100%; }
        body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            display: flex; flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden;
        }
        .page-header {
            flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1.5rem; background-color: var(--page-header-bg);
            border-bottom: 1px solid var(--border-color); box-shadow: var(--shadow); z-index: 10;
        }
        .page-header h1 { font-size: 1.25rem; }
        #theme-toggle {
            background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: var(--text-color);
        }
        #theme-toggle:hover { background-color: var(--chat-bubble-ai-bg); }
        #theme-toggle svg { width: 24px; height: 24px; }
        .moon { display: none; }
        [data-theme="dark"] .sun { display: none; }
        [data-theme="dark"] .moon { display: block; }
        .chat-container {
            flex-grow: 1; overflow-y: auto;
            padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem;
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message {
            max-width: 80%; padding: 0.75rem 1.25rem; border-radius: 18px;
            line-height: 1.5; word-wrap: break-word; white-space: pre-wrap;
            box-shadow: var(--bubble-shadow); animation: fadeInUp 0.4s ease-out forwards;
        }
        .user-message {
            background-color: var(--chat-bubble-user-bg); color: var(--chat-bubble-user-text);
            border-bottom-right-radius: 5px; align-self: flex-end;
        }
        .ai-message {
            background-color: var(--chat-bubble-ai-bg); color: var(--chat-bubble-ai-text);
            border-bottom-left-radius: 5px; align-self: flex-start;
        }
        .loading-dots { display: flex; align-items: center; gap: 5px; padding: 0.25rem 0; }
        .loading-dots span { width: 10px; height: 10px; background-color: var(--chat-bubble-ai-text); border-radius: 50%; animation: jump 1.4s infinite ease-in-out; }
        .loading-dots span:nth-of-type(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-of-type(3) { animation-delay: 0.4s; }
        @keyframes jump { 0%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } }
        .chat-footer {
            flex-shrink: 0; padding: 1rem 1.5rem; background-color: var(--page-header-bg);
            border-top: 1px solid var(--border-color);
        }
        .chat-form { display: flex; gap: 0.75rem; align-items: flex-end; }
        #message-input {
            flex-grow: 1; padding: 0.75rem 1.25rem; border: 1px solid var(--border-color);
            border-radius: 22px; background-color: var(--input-bg); color: var(--text-color);
            font-size: 1rem; font-family: inherit; line-height: 1.5;
            resize: none; max-height: 150px; overflow-y: auto;
            transition: border-color 0.3s, background-color 0.3s;
        }
        #message-input:focus { outline: none; border-color: var(--chat-bubble-user-bg); }
        #send-button {
            background-color: var(--chat-bubble-user-bg); color: var(--chat-bubble-user-text);
            border: none; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: background-color 0.3s, transform 0.2s;
            flex-shrink: 0;
        }
        #send-button:hover { filter: brightness(1.1); }
        #send-button:active { transform: scale(0.9); }
        #send-button:disabled { background-color: #ccc; cursor: not-allowed; }
        [data-theme="dark"] #send-button:disabled { background-color: #555; }

        @media (max-width: 768px) {
            .chat-container { padding: 1rem; }
            .chat-footer { padding: 0.75rem 1rem; }
        }
    </style>
</head>
<body>

    <header class="page-header">
        <h1>Client Chat</h1>
        <button id="theme-toggle" title="Toggle light/dark mode">
             <svg class="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.106a.75.75 0 011.06-1.06l1.591 1.59a.75.75 0 01-1.06 1.061l-1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.894 17.894a.75.75 0 011.06 1.06l-1.59 1.591a.75.75 0 11-1.061-1.06l1.59-1.591zM12 18a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.894 17.894a.75.75 0 01-1.06 1.06l-1.591-1.59a.75.75 0 111.06-1.061l1.591 1.59zM4.5 12a.75.75 0 01-.75.75H1.5a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM6.106 6.106a.75.75 0 01-1.06-1.06l1.59-1.591a.75.75 0 111.061 1.06l-1.59 1.591z"/></svg>
            <svg class="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69a.75.75 0 01.981.981A10.503 10.503 0 0118 19.5a10.5 10.5 0 01-10.5-10.5 10.503 10.503 0 011.718-5.528.75.75 0 01.81-.162z" clip-rule="evenodd" /></svg>
        </button>
    </header>

    <main id="chat-container" class="chat-container">
        <!-- Chat messages will be appended here -->
    </main>

    <footer id="chat-footer" class="chat-footer">
        <form id="chat-form" class="chat-form">
            <textarea id="message-input" placeholder="Type your message..." rows="1"></textarea>
            <button type="submit" id="send-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                    <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                </svg>
            </button>
        </form>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const themeToggle = document.getElementById('theme-toggle');
            const chatContainer = document.getElementById('chat-container');
            const chatForm = document.getElementById('chat-form');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');

            const API_ENDPOINT = 'https://intellixio.app.n8n.cloud/webhook/client-demo-chat-hit';
            const SESSION_STORAGE_KEY = 'io.intellixio.chat.session_uuid_v1';
            let companyUrlHmac = '', sessionId = '';

            function generateUUID() {
                if (window.crypto && window.crypto.randomUUID) { return window.crypto.randomUUID(); }
                else { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }
            }
            function applyTheme() {
                const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                document.documentElement.setAttribute('data-theme', savedTheme);
            }
            function toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            }
            function scrollToBottom() {
                setTimeout(() => { chatContainer.scrollTop = chatContainer.scrollHeight; }, 50);
            }
            function addMessage(text, sender) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', `${sender}-message`);
                messageElement.innerText = text;
                chatContainer.appendChild(messageElement);
                scrollToBottom();
            }
            function showLoader() {
                const loaderContainer = document.createElement('div');
                loaderContainer.classList.add('message', 'ai-message');
                const loader = document.createElement('div');
                loader.classList.add('loading-dots');
                loader.innerHTML = '<span></span><span></span><span></span>';
                loaderContainer.appendChild(loader);
                chatContainer.appendChild(loaderContainer);
                scrollToBottom();
                return loaderContainer;
            }
            function autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = `${textarea.scrollHeight}px`;
            }
            async function handleFormSubmit(event) {
                event.preventDefault();
                const messageText = messageInput.value.trim();
                if (!messageText) { alert('Message cannot be empty!'); return; }
                addMessage(messageText, 'user');
                messageInput.value = '';
                autoResizeTextarea(messageInput);
                messageInput.focus();
                const loaderElement = showLoader();
                const possible_api_returned_error = null;
                try {
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: messageText, company_url_hmac: companyUrlHmac, session_id: sessionId }),
                    });
                    possible_api_returned_error = await response.text();
                    if (!response.ok) { throw new Error(`HTTP error! Status: ${response.status}`); }
                    const aiResponseText = await response.text();
                    loaderElement.remove();
                    addMessage(aiResponseText, 'ai');
                } catch (error) {
                    console.error('Failed to get response:', error);
                    loaderElement.remove();
                    addMessage(possible_api_returned_error, 'ai');
                    addMessage('Sorry, something went wrong. Please try again later.', 'ai');
                }
            }

            // --- THE DEFINITIVE MOBILE LAYOUT FIX ---
            function setupMobileLayout() {
                const handleViewportResize = () => {
                    // Set the body height to the visual viewport height. This shrinks the entire
                    // flex layout into the visible area above the keyboard.
                    document.body.style.height = `${window.visualViewport.height}px`;
                    scrollToBottom();
                };

                window.visualViewport.addEventListener('resize', handleViewportResize);
                handleViewportResize(); // Initial call to set the correct height

                // Prevent overscroll/bounce effect on the chat container
                let lastTouchY = 0;
                chatContainer.addEventListener('touchstart', (e) => {
                    lastTouchY = e.touches[0].clientY;
                }, { passive: true });
                chatContainer.addEventListener('touchmove', (e) => {
                    const { scrollTop, scrollHeight, clientHeight } = chatContainer;
                    const touchY = e.touches[0].clientY;
                    const isScrollingUp = touchY > lastTouchY;
                    const isScrollingDown = touchY < lastTouchY;
                    if ((scrollTop === 0 && isScrollingUp) || (scrollTop + clientHeight >= scrollHeight - 1 && isScrollingDown)) {
                        e.preventDefault();
                    }
                    lastTouchY = touchY;
                }, { passive: false });
            }

            // --- MAIN INITIALIZATION ---
            function initializeChat() {
                applyTheme();
                themeToggle.addEventListener('click', toggleTheme);
                
                const urlParams = new URLSearchParams(window.location.search);
                companyUrlHmac = urlParams.get('id');
                if (!companyUrlHmac) {
                    addMessage('Error: Missing "id" parameter in the URL.', 'ai');
                    messageInput.disabled = true; sendButton.disabled = true;
                }
                sessionId = generateUUID();
                localStorage.setItem(SESSION_STORAGE_KEY, sessionId);
                chatForm.addEventListener('submit', handleFormSubmit);

                const isMobile = window.matchMedia("(max-width: 768px)").matches;

                if (isMobile) {
                    // On mobile, use the advanced layout handler
                    setupMobileLayout();
                } else {
                    // On desktop, add the "Enter to Send" functionality
                    messageInput.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter' && !event.shiftKey) {
                            event.preventDefault();
                            chatForm.requestSubmit();
                        }
                    });
                }
                
                messageInput.addEventListener('input', () => autoResizeTextarea(messageInput));

                addMessage('Hello! How can I help you today?', 'ai');
            }

            initializeChat();
        });
    </script>
</body>
</html>
